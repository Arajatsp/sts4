name: Akamai Purge on OSX
description: Purge Cache via Akamai Client API CLI on Mac OSX
inputs:
  command:
    description: The command from akamai purge command
    required: true
    default: invalidate
  urls:
    description: urls
    required: true
runs:
  using: "composite"
  steps:
    - name: Setup
      shell: bash
      run: |
        echo -e "${EDGERC}" > ~/.edgerc
        brew install go
        brew install akamai
        akamai install purge
    - name: Purge
      shell: bash
      run: |
        MAX=50000
        urls="${{ inputs.urls }}"
        if [ ${#urls} -ge $MAX ]; then
          echo "Too many URLs. Splitting URLS in batches..."  
          indices=`echo $urls | grep -o -b " "`
          offset=0
          length=0
          for idx in $indices
          do
            end=${idx%:*}
            echo "Index ${end}"
            new_length=$((end-start))
            if [ $new_length -ge $MAX ]; then
              echo "Batch from ${offset} of length ${length}"
              batch=${urls:$offset:$length}
              echo $batch
              offset=$((offset + length))
              length=$(($end - $offset))
            else
              length=$new_length
            fi
          done
          if [ $length -gt 0 ]; then
            length=$((${#urls} - offset + 1))
            echo "Last Batch from ${offset} of length ${length}"
            batch=${urls:$offset:$length}
            echo $batch
          fi
        else
          echo "Executing single Purge command..."  
          akamai purge --edgerc ~/.edgerc --section ccu ${{ inputs.command }} $urls
        fi
    - name: Cleanup
      if: ${{ always() }}
      shell: bash
      run: |
        rm -f ~/.edgerc
        akamai uninstall purge
        brew uninstall akamai
        brew uninstall go
